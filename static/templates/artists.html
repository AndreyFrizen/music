<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>–ü–æ–∏—Å–∫ –Ω–∞ Go —Å WebSocket</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }

            .search-container {
                margin-bottom: 30px;
            }

            #searchInput {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 4px;
            }

            .results {
                margin-top: 20px;
            }

            .result-item {
                border: 1px solid #eee;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 4px;
            }

            .result-title {
                font-size: 18px;
                color: #1a0dab;
                margin-bottom: 5px;
            }

            .result-url {
                color: #006621;
                font-size: 14px;
                margin-bottom: 5px;
            }

            .result-snippet {
                color: #545454;
                font-size: 14px;
            }

            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                display: none;
            }

            .loading {
                background-color: #e3f2fd;
                color: #1565c0;
            }

            .error {
                background-color: #ffebee;
                color: #c62828;
            }
        </style>
    </head>
    <body>
        <h1>üîç –ü–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ Go + WebSocket</h1>

        <div class="search-container">
            <input
                type="text"
                id="searchInput"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..."
                autocomplete="off"
            />
        </div>

        <div id="status" class="status"></div>

        <div id="results" class="results"></div>

        <script>
            class SearchClient {
                constructor() {
                    this.socket = null;
                    this.connect();
                    this.setupEventListeners();
                    this.debounceTimer = null;
                }

                connect() {
                    const protocol =
                        window.location.protocol === "https:" ? "wss:" : "ws:";
                    const wsUrl = `${protocol}//${window.location.host}/ws`;

                    this.socket = new WebSocket(wsUrl);

                    this.socket.onopen = () => {
                        console.log("WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω");
                        this.showStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "loading");
                        setTimeout(() => this.hideStatus(), 2000);
                    };

                    this.socket.onclose = () => {
                        console.log("WebSocket –æ—Ç–∫–ª—é—á–µ–Ω");
                        this.showStatus(
                            "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...",
                            "error",
                        );

                        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => this.connect(), 3000);
                    };

                    this.socket.onerror = (error) => {
                        console.error("WebSocket –æ—à–∏–±–∫–∞:", error);
                        this.showStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
                    };

                    this.socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);

                        if (data.type === "result") {
                            this.displayResults(data);
                            this.hideStatus();
                        } else if (data.type === "error") {
                            this.showStatus(`–û—à–∏–±–∫–∞: ${data.error}`, "error");
                        }
                    };
                }

                setupEventListeners() {
                    const searchInput = document.getElementById("searchInput");

                    searchInput.addEventListener("input", (e) => {
                        const query = e.target.value.trim();

                        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                        clearTimeout(this.debounceTimer);

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞
                        if (query.length > 0) {
                            this.showStatus("–ò–¥–µ—Ç –ø–æ–∏—Å–∫...", "loading");
                        } else {
                            this.clearResults();
                            this.hideStatus();
                            return;
                        }

                        // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º (debounce)
                        this.debounceTimer = setTimeout(() => {
                            this.performSearch(query);
                        }, 300);
                    });
                }

                performSearch(query) {
                    if (
                        !this.socket ||
                        this.socket.readyState !== WebSocket.OPEN
                    ) {
                        this.showStatus("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "error");
                        return;
                    }

                    const message = {
                        type: "search",
                        query: query,
                    };

                    this.socket.send(JSON.stringify(message));
                }

                displayResults(data) {
                    const resultsContainer = document.getElementById("results");

                    if (!data.results || data.results.length === 0) {
                        resultsContainer.innerHTML = `
                        <div class="result-item">
                            <p>–ü–æ –∑–∞–ø—Ä–æ—Å—É "${data.query}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                        </div>
                    `;
                        return;
                    }

                    let html = `<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è: "${data.query}"</h3>`;

                    data.results.forEach((item) => {
                        html += `
                        <div class="result-item">
                            <div class="result-title">
                                <a href="${item.url}" target="_blank">${item.title}</a>
                            </div>
                            <div class="result-url">${item.url}</div>
                            <div class="result-snippet">${item.snippet}</div>
                        </div>
                    `;
                    });

                    resultsContainer.innerHTML = html;
                }

                clearResults() {
                    document.getElementById("results").innerHTML = "";
                }

                showStatus(message, type) {
                    const statusEl = document.getElementById("status");
                    statusEl.textContent = message;
                    statusEl.className = `status ${type}`;
                    statusEl.style.display = "block";
                }

                hideStatus() {
                    document.getElementById("status").style.display = "none";
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener("DOMContentLoaded", () => {
                new SearchClient();
            });
        </script>
    </body>
</html>
